#!/usr/bin/env python3
# Weather report

import os
import sys
import json
import locale
import datetime
import subprocess
import urllib.request

CONF_DIR = "M4_ETC_DIR/me-darksky.d"
CONF_VAR = {"KEY", "LANG", "LATITUDE", "LONGTITUDE", "UNITS"}
API_URL = "https://api.darksky.net/forecast/{KEY}/{LATITUDE},{LONGTITUDE}?lang={LANG}&units={UNITS}"

def die(msg):
    print(msg)
    sys.exit(1)


def usage():
        die(
"""Usage: me-darksky [<options>]

Options:
  -l, --list-conf           List all configuration files
  -n, --new-conf            Create a new configuration file
  -v, --view-conf <conf>    Display content of a specified configuration file
  -e, --edit-conf <conf>    Edit an existed configuration file
  -d, --delete-conf <conf>  Delete an existed configuration file
  -r, --rename-conf <conf>  Rename an existed configuration file
  -c <conf>                 Run from an existed configuration file""")

def parse_conf():
    global report_today
    global report_next_day
    exec(open(conf).read())

    if not(CONF_VAR.issubset(locals())):
        die("Lack of some required variables.")

    for var in CONF_VAR:
        globals()[var] = locals()[var]

    if LANG == "en":
        report_today = (
            "{date} ({icon}): {summary} "
            "Direction of wind is {windBearing}, speed of wind is {windSpeed}km/h."
            "Minmum temperature is {apparentTemperatureMin}°C around at {apparentTemperatureMinTime}, "
            "Maximum temperature is {apparentTemperatureMax}°C around at {apparentTemperatureMaxTime}. "
            "Time of sunrise is {sunriseTime}, time of sunset is {sunsetTime}."
            "Moon phase (0-1) is {moonPhase}."
            "Humidity (0-1) is {humidity}."
            "Sky occluded by clouds (0-1) is {cloudCover}."
            "Precipitation intensity is {precipIntensity}.\n")
        report_next_day = (
            "{date} ({icon}): {summary} "
            "Direction of wind is {windBearing}, speed of wind is {windSpeed}km/h."
            "Temperature is about {apparentTemperatureMin}°C-{apparentTemperatureMax}°C.\n"
        )
        try: locale.setlocale(locale.LC_ALL, "en_US.UTF-8")
        except locale.Error: pass
    elif LANG == "zh":
        report_today = (
            "{date} ({icon})： {summary}"
            "{windBearing}风{windSpeed}km/h。"
            "{apparentTemperatureMinTime}点气温最低为{apparentTemperatureMin}°C，"
            "{apparentTemperatureMaxTime}点气温最高为{apparentTemperatureMax}°C。"
            "日出为{sunriseTime}，日落为{sunsetTime}。"
            "月相 (0-1) 为 {moonPhase}。"
            "湿度 (0-1) 为 {humidity}。"
            "云层 (0-1) 为 {cloudCover}。"
            "降水量密度为 {precipIntensity}mm/h。\n")
        report_next_day = (
            "{date} ({icon})： {summary}"
            "{windBearing}风{windSpeed}km/h。"
            "温度{apparentTemperatureMin}°C-{apparentTemperatureMax}°C。\n"
        )
        try: locale.setlocale(locale.LC_ALL, "zh_CN.UTF-8")
        except locale.Error: pass
    else:
        die("Unknown value of configuration variable 'LANG': %s." % str(LANG))

    if UNITS not in ["auto", "ca", "uk2", "us", "si"]:
        die("Unknown value of configuration variable 'UNITS': %s." % str(UNITS))

    if type(LATITUDE) not in [int, float]:
        die("Type of configuration variable 'LATITUDE' must be int or float.")

    if LATITUDE > 90 or LATITUDE < -90:
        die("Value of configuration variable 'LATITUDE' is out of range: %s." %
            str(LATITUDE))

    if type(LONGTITUDE) not in [int, float]:
        die("Type of configuration variable 'LONGTITUDE' must be int or float.")

    if LONGTITUDE > 180 or LONGTITUDE < -180:
        die("Value of configuration variable 'LATITUDE' is out of range: %s." %
            str(LATITUDE))

def wind_direction(wind_bearing, lang="en"):
    direction = ""

    if 0 < wind_bearing < 180:
        if lang == "en": direction += "East"
        elif lang == "zh" : direction += "东"
    elif 180 < wind_bearing < 360:
        if lang == "en": direction += "West"
        elif lang == "zh" : direction += "西"

    if 0 <= wind_bearing < 90 or 270 < wind_bearing <= 360:
        if lang == "en": direction = "North" + direction
        elif lang == "zh" : direction += "北"
    elif 90 < wind_bearing < 270:
        if lang == "en": direction = "Sourth" + direction
        elif lang == "zh" : direction += "南"

    return direction or wind_bearing

def parse_data():
    tz = datetime.timezone(datetime.timedelta(hours=globals()["LONGTITUDE"] // 15))
    ts2h = lambda ts: datetime.datetime.fromtimestamp(ts, tz=tz).strftime("%H")
    ts2hm = lambda ts: datetime.datetime.fromtimestamp(ts, tz=tz).strftime("%H:%M")

    report = ""
    with urllib.request.urlopen(API_URL.format(**globals())) as resp:
        data = json.loads(resp.read())
        for i, day in enumerate(data["daily"]["data"][0:]):
            report += (report_today if i == 0 else report_next_day).format(**{
                "date": (datetime.datetime.now(tz)
                            + datetime.timedelta(days=i)).strftime("%Y/%m/%d %A"),
                "icon": day["icon"],
                "summary": day["summary"],
                "windSpeed": day["windSpeed"],
                "windBearing": wind_direction(day["windBearing"], lang=globals()["LANG"]),
                "apparentTemperatureMin": day["apparentTemperatureMin"],
                "apparentTemperatureMax": day["apparentTemperatureMax"],
                "apparentTemperatureMinTime": ts2h(day["apparentTemperatureMinTime"]),
                "apparentTemperatureMaxTime": ts2h(day["apparentTemperatureMaxTime"]),
                "sunsetTime": ts2hm(day["sunsetTime"]),
                "sunriseTime": ts2hm(day["sunriseTime"]),
                "windSpeed": day["windSpeed"],
                "windBearing": wind_direction(day["windBearing"], lang=globals()["LANG"]),
                "humidity": day["humidity"],
                "moonPhase": day["moonPhase"],
                "cloudCover": day["cloudCover"],
                "precipIntensity": day["precipIntensity"],
            })
    return report


if __name__ == "__main__":
    if len(sys.argv) == 2 and sys.argv[1] in ["-l", "--list-conf"]:
        subprocess.run(["me", "conf-list", "darksky"])

    elif len(sys.argv) == 2 and sys.argv[1] in ["-n", "--new-conf"]:
        subprocess.run(["me", "conf-new", "darksky"])

    elif len(sys.argv) == 3 and sys.argv[1] in ["-v", "--view-conf"]:
        subprocess.run(["me", "conf-view", "darksky", sys.argv[2]])

    elif len(sys.argv) == 3 and sys.argv[1] in ["-e", "--edit-conf"]:
        subprocess.run(["me", "conf-edit", "darksky", sys.argv[2]])

    elif len(sys.argv) == 3 and sys.argv[1] in ["-d", "--delete-conf"]:
        subprocess.run(["me", "conf-delete", "darksky", sys.argv[2]])

    elif len(sys.argv) == 3 and sys.argv[1] in ["-r", "--rename-conf"]:
        subprocess.run(["me", "conf-rename", "darksky", sys.argv[2]])

    elif len(sys.argv) == 3 and sys.argv[1] in ["-c"]:
        conf = os.path.join(CONF_DIR, sys.argv[2] + ".conf")
        if not os.path.isfile(conf):
            die("Cannot find configuration file '%s'." % conf)

        parse_conf()
        print(parse_data())

    else:
        usage()

